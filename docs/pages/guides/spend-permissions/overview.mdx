# Spend Permissions

Spend Permissions enable third-party signers to spend assets (native and ERC-20 tokens) from user wallets. 
This unlocks the following use cases: // TODO make note about reduced signing
- frequent in-game spending
- subscription payments
- auto-renewals
- automated or event-based trading
- micropayment streaming

Differences between Spend Permissions and ERC-20 permits:
- Spend Permissions **supports all ERC-20 assets**, whereas permits only support ERC-20s that implement the permit standard  
- Spend Permissions **enable spending native tokens**  
- Spend Permissions offers granular **controls for recurrence**  
- The logic that controls asset movements is **implemented in the user's wallet**, not the asset contract  


## The `SpendPermission` details
A spend permission is defined by the following parameters

```solidity
struct SpendPermission {
    address account;
    address spender;
    address token;
    uint160 allowance;
    uint48 period;
    uint48 start;
    uint48 end;
    uint256 salt;
    bytes extraData;
}
```


## Approving

A user approves a spend permission by signing an [ERC-712](https://eips.ethereum.org/EIPS/eip-712) typed object that contains
the spend permission properties. This signature and the corresponding spend permission details are then submitted to 
`SpendPermissionManager.approveWithSignature` to approve the spend permission onchain.

Multiple spend permissions can be batched and approved with a single signature by constructing a batch spend permission object
and approving with `SpendPermissionManager.approveBatchWithSignature`.


## Revoking

Users can revoke permissions at any time by calling `SpendPermissionManager.revoke`. Calls to revoke can be batched via 
`CoinbaseSmartWallet.executeBatch`. Once a spend permission has been revoked, it can never be re-approved. 

If the user wants to re-authorize the spend permission, the spender will need to generate a new spend permission 
that has a unique hash from the original spend permission. If the details of the new spend permission are identical
to the revoked permission, the `salt` field of the permission should be used to generate a unique hash.

## Cycle accounting

Spend Permissions offers granular controls for recurrence (e.g. 10 USDC / month). 
As the third-party signer spends user assets, the `SpendPermissionManager` contract tracks cumulative spend and enforces the per-period
allowance. If there are multiple periods defined during the valid lifespan of the spend permission, the cumulative usage resets to 0 
at the beginning of the next period, allowing the spender to once again spend up to the allowance.

This behavior is parameterized by the `start`, `end`, `period` and `allowance` properties of the permission.

Note that spend permissions can be used for non-recurring allowances, either indefinite or with expiry, by setting
a period durantion that spans the entire range between start and end.

A comprehensive example of spend permission accounting can be found [here](https://github.com/coinbase/spend-permissions/blob/main/docs/SpendPermissionAccounting.md).

## Additional resources
Contract sourcecode, diagrams, and additional documentation can be found in the open-source [contracts repository](https://github.com/coinbase/spend-permissions).
